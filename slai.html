<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½èŠå¤©åŠ©æ‰‹ï¼ˆæ”¯æŒç»´è¯­ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h3 {
            font-size: 12px;
            margin-bottom: 20px;
            /* å¢å¤§ä¸æŒ‰é’®çš„é—´è· */
        }

        .header-buttons {
            position: static;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: -12px;
            margin-bottom: 16px;
            /* å¢å¤§åº•éƒ¨é—´è· */
            z-index: 2;
        }

        .header-button {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .header-button svg {
            width: 14px;
            height: 14px;
        }

        .config-section {
            padding: 20px;
            background-color: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
        }

        .config-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .config-group label {
            font-weight: bold;
            min-width: 80px;
        }

        .config-group input,
        .config-group select {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .config-group input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            position: relative;
            transition: opacity 0.3s, transform 0.3s;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message.deleting {
            opacity: 0.5;
            transform: translateX(20px);
        }

        .message.selected {
            outline: 2px solid #3498db;
            border-radius: 10px;
            padding: 5px;
            margin: -5px 0 15px 0;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: #3498db;
        }

        .message.assistant .message-avatar {
            background-color: #2ecc71;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            position: relative;
            /* é»˜è®¤æ­£å¸¸æ–¹å‘ */
            direction: ltr;
            text-align: left;
            /* æ”¹è¿›æ–‡æœ¬æ¸²æŸ“ */
            line-height: 1.5;
        }

        /* æ”¹è¿›Markdownå†…å®¹æ¸²æŸ“ */
        .message-content p {
            margin-bottom: 8px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .message-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .message-content blockquote {
            border-left: 3px solid #ddd;
            padding-left: 10px;
            color: #666;
            margin: 8px 0;
        }

        /* ä»å³å‘å·¦çš„å†…å®¹æ ·å¼ */
        .message-content.rtl {
            direction: rtl;
            text-align: right;
        }

        .message.user .message-content {
            background-color: #3498db;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background-color: #ecf0f1;
            color: #2c3e50;
            border-bottom-left-radius: 4px;
        }

        /* åˆ é™¤æŒ‰é’® */
        .delete-button {
            position: absolute;
            top: 0;
            right: auto;
            left: -30px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #e74c3c;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.user .delete-button {
            left: auto;
            right: -30px;
        }

        .message:hover .delete-button {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .delete-button {
                opacity: 1;
                /* Always show delete buttons on mobile */
                top: -10px;
                /* Position slightly above the message */
                left: 0;
                /* Adjust position for better visibility */
            }

            .message.user .delete-button {
                left: auto;
                right: 0;
            }
        }

        /* æ¶ˆæ¯æ“ä½œæŒ‰é’® */
        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .message-content.rtl .message-actions {
            right: auto;
            left: 5px;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background-color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .action-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }

        /* æ‰¹é‡åˆ é™¤æ§åˆ¶æ  */
        .bulk-controls {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: none;
            gap: 10px;
            align-items: center;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .bulk-controls.visible {
            display: flex;
        }

        .bulk-controls button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .bulk-controls .cancel-btn {
            background-color: #7f8c8d;
            color: white;
        }

        .bulk-controls .delete-btn {
            background-color: #e74c3c;
            color: white;
        }

        /* å¤åˆ¶æˆåŠŸæç¤º */
        .copy-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .input-section {
            padding: 20px;
            background-color: #ecf0f1;
            border-top: 1px solid #bdc3c7;
            position: relative;
        }

        .input-group {
            display: flex;
            gap: 10px;
            position: relative;
            align-items: flex-end;
        }

        /* æ›¿æ¢ä¸ºtextareaçš„æ ·å¼ */
        #messageInput {
            flex: 1;
            min-height: 38px;
            max-height: 150px;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            resize: none;
            overflow-y: auto;
            font-family: inherit;
            line-height: 1.4;
        }

        #messageInput:focus {
            border-color: #3498db;
        }

        #sendButton {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #sendButton:hover {
            background-color: #2980b9;
        }

        #sendButton:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        #stopButton {
            padding: 12px 24px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: none;
        }

        #stopButton:hover {
            background-color: #c0392b;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            color: #e74c3c;
            padding: 10px;
            background-color: #fee;
            border-radius: 4px;
            margin-top: 10px;
        }

        .success-message {
            color: #27ae60;
            padding: 10px;
            background-color: #efe;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* é«˜çº§è®¾ç½®åŒºåŸŸ */
        .advanced-settings {
            margin-top: 10px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            display: none;
        }

        .advanced-toggle {
            cursor: pointer;
            color: #3498db;
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
        }

        .language-settings {
            display: flex;
            align-items: center;
            margin-top: 10px;
            gap: 10px;
        }

        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        .confirm-dialog.visible {
            opacity: 1;
            visibility: visible;
        }

        .dialog-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .dialog-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .dialog-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .dialog-buttons .cancel {
            background-color: #ecf0f1;
            color: #7f8c8d;
        }

        .dialog-buttons .confirm {
            background-color: #e74c3c;
            color: white;
        }

        /* æ–‡ä»¶ä¸Šä¼ ç›¸å…³æ ·å¼ */
        .file-upload-container {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background-color: #f7f9fa;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: none;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
            z-index: 5;
        }

        .file-upload-container.active {
            display: block;
        }

        .file-drop-area {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 10px;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }

        .file-drop-area.dragging {
            border-color: #3498db;
            background-color: #e1f0fa;
        }

        .file-drop-area p {
            margin-bottom: 10px;
            color: #7f8c8d;
        }

        .file-upload-button {
            display: inline-block;
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .file-upload-button:hover {
            background-color: #2980b9;
        }

        .file-input {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .file-item {
            position: relative;
            width: 100px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f5f5f5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .file-thumbnail {
            height: 70px;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .file-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-thumbnail .file-icon {
            font-size: 30px;
            color: #7f8c8d;
        }

        .file-info {
            padding: 5px;
            font-size: 10px;
            text-align: center;
            word-break: break-all;
        }

        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 10px;
        }

        .file-size {
            font-size: 9px;
            color: #7f8c8d;
        }

        .file-status {
            font-size: 9px;
            font-weight: bold;
        }

        .file-status.uploading {
            color: #f39c12;
        }

        .file-status.success {
            color: #27ae60;
        }

        .file-status.error {
            color: #e74c3c;
        }

        .file-delete {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background-color: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* é‡æ–°å®šä½é™„ä»¶å›¾æ ‡ */
        .attachment-indicator {
            position: relative;
            left: auto;
            right: auto;
            top: auto;
            transform: none;
            color: #3498db;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: flex-end;
            margin-bottom: 4px;
        }

        .attachment-indicator.active {
            color: #2ecc71;
        }

        .file-upload-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background-color: rgba(0, 0, 0, 0.1);
            color: #7f8c8d;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç¼–è¾‘/é‡æ–°å‘é€åŠŸèƒ½æ ·å¼ */
        .edit-button {
            position: absolute;
            top: 0;
            right: auto;
            left: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.user .edit-button {
            left: auto;
            right: 10px;
        }

        .resend-button {
            position: absolute;
            top: 30px;
            right: auto;
            left: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #2ecc71;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.user .resend-button {
            left: auto;
            right: 10px;
        }

        /* æ‚¬åœæ—¶æ›´æ˜æ˜¾ */
        .message:hover .edit-button,
        .message:hover .resend-button {
            opacity: 1;
        }

        /* æ·»åŠ æ¶ˆæ¯æ—¶é—´æˆ³ */
        .message-timestamp {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: right;
        }

        .message.user .message-timestamp {
            text-align: left;
        }

        /* å“åº”å¼æ ·å¼ */
        @media (max-width: 768px) {
            .config-group {
                flex-direction: column;
                align-items: stretch;
            }

            .config-group label {
                min-width: auto;
            }

            .message-content {
                max-width: 85%;
            }

            .header h1 {
                font-size: 20px;
                padding-right: 100px;
            }

            .header-buttons {
                transform: scale(0.9) translateY(-50%);
            }

            .bulk-controls {
                width: 90%;
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .container {
                height: 100dvh;
                min-height: 0;
            }

            .config-section {
                padding: 6px 4px 6px 4px;
                font-size: 13px;
                max-height: 120px;
                overflow-y: auto;
            }

            .config-group {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }

            .config-group label {
                min-width: auto;
                font-size: 13px;
            }

            .advanced-settings {
                padding-top: 4px;
                margin-top: 4px;
                font-size: 12px;
            }

            .input-section {
                padding: 6px 4px;
            }

            .input-group {
                gap: 4px;
            }

            #messageInput {
                min-height: 32px;
                font-size: 14px;
                padding: 8px;
                border-radius: 18px;
            }

            #sendButton,
            #stopButton {
                padding: 8px 12px;
                font-size: 14px;
                border-radius: 18px;
            }

            .chat-container {
                padding: 8px 2px;
                min-height: 120px;
                max-height: calc(100dvh - 220px);
                /* 220px = config-section+input-sectionæœ€å¤§é«˜åº¦+ä½™é‡ */
            }

            .message-content {
                max-width: 98%;
                padding: 8px;
                font-size: 14px;
            }

            .header h1 {
                font-size: 18px;
                padding-right: 0;
            }

            .header h3 {
                font-size: 12px;
            }

            .header-buttons {
                transform: none;
                margin-top: 4px;
                justify-content: center;
            }

            .bulk-controls {
                width: 98%;
                font-size: 13px;
                padding: 6px 4px;
            }

            /* ä¿è¯å›¾ç‰‡ä¸æ’‘æ»¡å± */
            .message-content img {
                max-width: 100% !important;
                height: auto !important;
                max-height: 180px !important;
                object-fit: contain !important;
            }

            /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸé€‚é… */
            .file-upload-container {
                padding: 6px 2px;
            }

            .file-item {
                width: 70px;
                height: 90px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½èŠå¤©åŠ©æ‰‹ï¼ˆæ”¯æŒç»´è¯­ç‰ˆï¼‰</h1>
            <h3>æœ¬ç«™ç‚¹ä»…ç”¨äºå›¢é˜Ÿé¡¹ç›®ç ”ç©¶ï¼Œè¯·å‹¿å¤–ä¼ ï¼Œåˆ‡å‹¿ä¸Šä¼ æˆ–ç”Ÿæˆæ”¿æ²»ã€ä¿å¯†ã€è¿æ³•ç›¸å…³æ–‡ä»¶</h3>
            <div class="header-buttons">
                <button id="exportButton" class="header-button" title="å¯¼å‡ºå¯¹è¯">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M12 3v12M7 11l5 5 5-5M5 21h14"></path>
                    </svg>
                    å¯¼å‡º
                </button>
                <button id="clearButton" class="header-button" title="æ¸…ç©ºèŠå¤©">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                    </svg>
                    æ¸…ç©º
                </button>
            </div>
        </div>

        <div class="config-section">
            <div class="config-group" style="margin-bottom: 10px;">
                <label for="apiUrl">APIåœ°å€:</label>
                <input type="text" id="apiUrl" placeholder="è¯·è¾“å…¥APIåœ°å€"
                    value="https://api.2023gpt.top/v1/chat/completions">
                <label for="apiKey">API Key:</label>
                <input type="text" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„API Key">
            </div>
            <div class="config-group">
                <label for="modelSelect">æ¨¡å‹:</label>
                <select id="modelSelect">
                    <option value="ç»´è¯­ç¿»è¯‘">ç»´è¯­ç¿»è¯‘</option>
                    <option value="gpt-4o-all">GPT-4O</option>
                    <option value="å­¦æœ¯ç§‘ç ”1">å­¦æœ¯ç§‘ç ”1</option>
                    <option value="å­¦æœ¯ç§‘ç ”3">å­¦æœ¯ç§‘ç ”2</option>
                    <option value="ResearchGPT">ResearchGPT</option>
                    <option value="Pubmedæ£€ç´¢">Pubmedæ£€ç´¢</option>
                    <option value="PubMedæŠ¥å‘Š">PubMedæŠ¥å‘Š</option>
                    <option value="ç»˜å›¾">ç»˜å›¾1</option>
                    <option value="flux">ç»˜å›¾2</option>
                    <option value="url-analysis">é“¾æ¥å†…å®¹åˆ†æ</option>
                    <option value="veo3-fast">veo3-fast</option>
                </select>
                <label for="tempSlider">æ¸©åº¦:</label>
                <input type="range" id="tempSlider" min="0" max="2" step="0.1" value="0.7">
                <span id="tempValue">0.7</span>
                <label for="streamCheckbox">æµå¼è¾“å‡º:</label>
                <input type="checkbox" id="streamCheckbox" checked>
            </div>
            <div class="advanced-toggle" id="advancedToggle">æ˜¾ç¤ºé«˜çº§è®¾ç½® â–¼</div>
            <div class="advanced-settings" id="advancedSettings">
                <div class="language-settings">
                    <label for="textDirectionSelect">æ–‡å­—æ–¹å‘:</label>
                    <select id="textDirectionSelect">
                        <option value="ltr">ä»å·¦åˆ°å³</option>
                        <option value="rtl">ä»å³åˆ°å·¦</option>
                    </select>
                    <label for="maxTokens">æœ€å¤§Token:</label>
                    <input type="number" id="maxTokens" min="100" max="1000000" value="128000" style="width: 100px;">
                </div>
                <div class="config-group" style="margin-top: 10px;">
                    <label for="systemPrompt">ç³»ç»Ÿæç¤º:</label>
                    <input type="text" id="systemPrompt" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºä¿¡æ¯">
                </div>
                <div class="config-group" style="margin-top: 10px;">
                    <label for="contextLength">ä¸Šä¸‹æ–‡é•¿åº¦:</label>
                    <input type="number" id="contextLength" min="1" max="50" value="10" style="width: 100px;">
                    <span id="contextLengthDesc">ä¿ç•™æœ€è¿‘10æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡</span>
                </div>
                <div style="margin-top: 10px;">
                    <label for="selectionModeCheckbox" style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="selectionModeCheckbox">
                        <span style="margin-left: 5px;">å¯ç”¨æ‰¹é‡é€‰æ‹©æ¨¡å¼</span>
                    </label>
                </div>
            </div>
            <div id="statusMessage"></div>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <div class="bulk-controls" id="bulkControls">
            <span id="selectedCount">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</span>
            <button class="cancel-btn" id="cancelSelectButton">å–æ¶ˆ</button>
            <button class="delete-btn" id="bulkDeleteButton">åˆ é™¤é€‰ä¸­</button>
        </div>

        <div class="input-section">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="file-upload-container" id="fileUploadContainer">
                <button class="file-upload-close" id="fileUploadClose">Ã—</button>
                <div class="file-drop-area" id="fileDropArea">
                    <p>æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                    <label for="fileInput" class="file-upload-button">é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" id="fileInput" class="file-input" multiple>
                </div>
                <div class="file-preview" id="filePreview"></div>
            </div>

            <div class="input-group">
                <div class="attachment-indicator" id="attachmentIndicator" title="é™„ä»¶">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48">
                        </path>
                    </svg>
                </div>
                <!-- æ›¿æ¢inputä¸ºtextarea -->
                <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." autofocus></textarea>
                <button id="sendButton">å‘é€</button>
                <button id="stopButton">åœæ­¢</button>
            </div>
        </div>
    </div>

    <div class="copy-toast" id="copyToast">å¤åˆ¶æˆåŠŸ</div>

    <div class="confirm-dialog" id="confirmDialog">
        <div class="dialog-content">
            <div class="dialog-title" id="dialogTitle">ç¡®è®¤æ“ä½œ</div>
            <div id="dialogMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
            <div class="dialog-buttons">
                <button class="cancel" id="dialogCancel">å–æ¶ˆ</button>
                <button class="confirm" id="dialogConfirm">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ Markdownè§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let conversationHistory = [];
        let isGenerating = false;
        let selectionMode = false;
        let selectedMessages = new Set();
        let messageElements = new Map(); // æ¶ˆæ¯IDåˆ°DOMå…ƒç´ çš„æ˜ å°„
        let messageCounter = 0; // ç”¨äºç”Ÿæˆå”¯ä¸€ID
        let abortController = null; // ç”¨äºä¸­æ­¢è¯·æ±‚
        let uploadedFiles = []; // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶
        let uploadedFileUrls = []; // å­˜å‚¨ä¸Šä¼ æˆåŠŸåçš„æ–‡ä»¶URL
        let currentEditingMessageId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¶ˆæ¯ID

        // DOMå…ƒç´ 
        const apiUrlInput = document.getElementById('apiUrl');
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelect = document.getElementById('modelSelect');
        const tempSlider = document.getElementById('tempSlider');
        const tempValue = document.getElementById('tempValue');
        const streamCheckbox = document.getElementById('streamCheckbox');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const stopButton = document.getElementById('stopButton');
        const clearButton = document.getElementById('clearButton');
        const exportButton = document.getElementById('exportButton');
        const statusMessage = document.getElementById('statusMessage');
        const copyToast = document.getElementById('copyToast');
        const textDirectionSelect = document.getElementById('textDirectionSelect');
        const systemPrompt = document.getElementById('systemPrompt');
        const maxTokens = document.getElementById('maxTokens');
        const contextLength = document.getElementById('contextLength');
        const contextLengthDesc = document.getElementById('contextLengthDesc');
        const advancedToggle = document.getElementById('advancedToggle');
        const advancedSettings = document.getElementById('advancedSettings');
        const selectionModeCheckbox = document.getElementById('selectionModeCheckbox');
        const bulkControls = document.getElementById('bulkControls');
        const selectedCount = document.getElementById('selectedCount');
        const cancelSelectButton = document.getElementById('cancelSelectButton');
        const bulkDeleteButton = document.getElementById('bulkDeleteButton');
        const confirmDialog = document.getElementById('confirmDialog');
        const dialogTitle = document.getElementById('dialogTitle');
        const dialogMessage = document.getElementById('dialogMessage');
        const dialogCancel = document.getElementById('dialogCancel');
        const dialogConfirm = document.getElementById('dialogConfirm');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const fileUploadClose = document.getElementById('fileUploadClose');
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const attachmentIndicator = document.getElementById('attachmentIndicator');

        // è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ–¹å‘çš„æ­£åˆ™è¡¨è¾¾å¼ (é˜¿æ‹‰ä¼¯æ–‡ã€æ³¢æ–¯æ–‡ã€ç»´å¾å°”æ–‡ç­‰å­—ç¬¦èŒƒå›´)
        const rtlRegex = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;

        // é…ç½®Markedé€‰é¡¹ï¼ˆé’ˆå¯¹Markdownæ¸²æŸ“ï¼‰
        marked.setOptions({
            breaks: true, // å¯ç”¨æ¢è¡Œç¬¦æ”¯æŒ
            gfm: true,    // å¯ç”¨GitHubé£æ ¼çš„Markdown
            headerIds: false, // ç¦ç”¨è‡ªåŠ¨æ·»åŠ IDåˆ°æ ‡é¢˜
            mangle: false, // ç¦ç”¨è‡ªåŠ¨è½¬ä¹‰html entities
            smartLists: true // ä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ—è¡¨è¡Œä¸º
        });

        // æå–çº¯æ–‡æœ¬å†…å®¹ï¼ˆå»é™¤Markdownå’Œæ—¶é—´æˆ³ï¼‰
        function extractPlainText(htmlContent) {
            // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ 
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            // ç§»é™¤æ—¶é—´æˆ³å…ƒç´ 
            const timestamps = tempDiv.querySelectorAll('.message-timestamp');
            timestamps.forEach(el => el.remove());

            // ç§»é™¤æ“ä½œæŒ‰é’®
            const actions = tempDiv.querySelectorAll('.message-actions');
            actions.forEach(el => el.remove());

            // è·å–çº¯æ–‡æœ¬å†…å®¹
            return tempDiv.textContent || tempDiv.innerText || "";
        }

        // æ·»åŠ textareaè‡ªåŠ¨è°ƒæ•´é«˜åº¦åŠŸèƒ½
        function autoResizeTextarea(textarea) {
            // é‡ç½®é«˜åº¦ä»¥è·å–æ­£ç¡®çš„scrollHeight
            textarea.style.height = 'auto';

            // è®¾ç½®æ–°é«˜åº¦åŸºäºscrollHeightï¼Œå¹¶é™åˆ¶æœ€å¤§é«˜åº¦
            const newHeight = Math.min(textarea.scrollHeight, 150);
            textarea.style.height = newHeight + 'px';
        }

        // ä¸ºtextareaæ·»åŠ è‡ªåŠ¨è°ƒæ•´é«˜åº¦çš„äº‹ä»¶ç›‘å¬
        messageInput.addEventListener('input', function () {
            autoResizeTextarea(this);
        });

        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³åˆå§‹åŒ–
        attachmentIndicator.addEventListener('click', () => {
            fileUploadContainer.classList.toggle('active');
        });

        fileUploadClose.addEventListener('click', () => {
            fileUploadContainer.classList.remove('active');
        });

        // æ‹–æ”¾æ–‡ä»¶ç›¸å…³äº‹ä»¶
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            fileDropArea.classList.add('dragging');
        }

        function unhighlight() {
            fileDropArea.classList.remove('dragging');
        }

        fileDropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFileList(files);
        }

        function handleFiles(e) {
            const files = e.target.files;
            handleFileList(files);
        }

        function handleFileList(files) {
            if (files.length === 0) return;

            // æ·»åŠ æ–‡ä»¶åˆ°ä¸Šä¼ åˆ—è¡¨å¹¶ç«‹å³å¼€å§‹ä¸Šä¼ 
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶ (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showStatus(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBé™åˆ¶ï¼Œæ— æ³•ä¸Šä¼ `, 'error');
                    continue;
                }

                // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
                uploadedFiles.push(file);

                // æ·»åŠ é¢„è§ˆ
                const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                addFilePreview(file, fileId);

                // ç«‹å³å¼€å§‹ä¸Šä¼ æ­¤æ–‡ä»¶
                uploadFile(file, fileId);
            }

            // æ›´æ–°é™„ä»¶æŒ‡ç¤ºå™¨
            updateAttachmentIndicator();

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ä»¥å…è®¸å†æ¬¡é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
            fileInput.value = '';
        }

        function addFilePreview(file, fileId) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.dataset.id = fileId;

            const thumbnail = document.createElement('div');
            thumbnail.className = 'file-thumbnail';

            // æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡æ–‡ä»¶
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                thumbnail.appendChild(img);
            } else {
                // éå›¾ç‰‡æ–‡ä»¶æ˜¾ç¤ºå›¾æ ‡
                const fileIcon = document.createElement('div');
                fileIcon.className = 'file-icon';

                // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
                if (file.type.includes('pdf')) {
                    fileIcon.innerHTML = 'ğŸ“„';
                } else if (file.type.includes('word') || file.type.includes('document')) {
                    fileIcon.innerHTML = 'ğŸ“';
                } else if (file.type.includes('spreadsheet') || file.type.includes('excel')) {
                    fileIcon.innerHTML = 'ğŸ“Š';
                } else if (file.type.includes('presentation') || file.type.includes('powerpoint')) {
                    fileIcon.innerHTML = 'ğŸ“Š';
                } else if (file.type.includes('text')) {
                    fileIcon.innerHTML = 'ğŸ“ƒ';
                } else if (file.type.includes('zip') || file.type.includes('rar') || file.type.includes('archive')) {
                    fileIcon.innerHTML = 'ğŸ“¦';
                } else if (file.type.includes('audio')) {
                    fileIcon.innerHTML = 'ğŸµ';
                } else if (file.type.includes('video')) {
                    fileIcon.innerHTML = 'ğŸ¬';
                } else {
                    fileIcon.innerHTML = 'ğŸ“';
                }

                thumbnail.appendChild(fileIcon);
            }

            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';

            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.title = file.name;
            fileName.textContent = file.name;

            const fileSize = document.createElement('div');
            fileSize.className = 'file-size';
            fileSize.textContent = formatFileSize(file.size);

            const fileStatus = document.createElement('div');
            fileStatus.className = 'file-status uploading';
            fileStatus.textContent = 'ä¸Šä¼ ä¸­...';
            fileStatus.dataset.id = fileId;

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'file-delete';
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.title = 'åˆ é™¤æ–‡ä»¶';
            deleteBtn.addEventListener('click', () => {
                // ä»ä¸Šä¼ åˆ—è¡¨ä¸­åˆ é™¤
                const fileIndex = uploadedFiles.findIndex(f => f === file);
                if (fileIndex !== -1) {
                    uploadedFiles.splice(fileIndex, 1);
                }

                // ä»URLåˆ—è¡¨ä¸­åˆ é™¤
                const urlIndex = uploadedFileUrls.findIndex(u => u.fileId === fileId);
                if (urlIndex !== -1) {
                    uploadedFileUrls.splice(urlIndex, 1);
                }

                // ä»DOMä¸­åˆ é™¤
                fileItem.remove();

                // æ›´æ–°é™„ä»¶æŒ‡ç¤ºå™¨
                updateAttachmentIndicator();
            });

            fileInfo.appendChild(fileName);
            fileInfo.appendChild(fileSize);
            fileInfo.appendChild(fileStatus);
            fileItem.appendChild(thumbnail);
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(deleteBtn);

            filePreview.appendChild(fileItem);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateAttachmentIndicator() {
            if (uploadedFileUrls.length > 0) {
                attachmentIndicator.classList.add('active');
                attachmentIndicator.title = `å·²æ·»åŠ  ${uploadedFileUrls.length} ä¸ªæ–‡ä»¶`;
            } else {
                attachmentIndicator.classList.remove('active');
                attachmentIndicator.title = 'æ·»åŠ é™„ä»¶';
            }
        }

        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶åˆ°æœåŠ¡å™¨
        async function uploadFile(file, fileId) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                updateFileStatus(fileId, 'error', 'æœªè®¾ç½®API Key');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('https://api.2023gpt.top/fileSystem/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': apiKey
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // ä¸Šä¼ æˆåŠŸï¼Œä¿å­˜URL
                    updateFileStatus(fileId, 'success', 'ä¸Šä¼ æˆåŠŸ');

                    // å­˜å‚¨æ–‡ä»¶URL
                    uploadedFileUrls.push({
                        fileId: fileId,
                        url: result.url,
                        filename: file.name
                    });

                    updateAttachmentIndicator();
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
                updateFileStatus(fileId, 'error', 'ä¸Šä¼ å¤±è´¥');
            }
        }

        // æ›´æ–°æ–‡ä»¶çŠ¶æ€
        function updateFileStatus(fileId, status, message) {
            const statusElement = document.querySelector(`.file-status[data-id="${fileId}"]`);
            if (statusElement) {
                statusElement.className = `file-status ${status}`;
                statusElement.textContent = message;
            }
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, callback) {
            dialogTitle.textContent = title;
            dialogMessage.textContent = message;
            confirmDialog.classList.add('visible');

            dialogConfirm.onclick = () => {
                confirmDialog.classList.remove('visible');
                callback(true);
            };

            dialogCancel.onclick = () => {
                confirmDialog.classList.remove('visible');
                callback(false);
            };
        }

        // ä¸Šä¸‹æ–‡é•¿åº¦è®¾ç½®
        contextLength.addEventListener('input', () => {
            const length = parseInt(contextLength.value);
            contextLengthDesc.textContent = `ä¿ç•™æœ€è¿‘${length}æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡`;
            saveConfig();
        });

        // é«˜çº§è®¾ç½®æ˜¾ç¤º/éšè—
        advancedToggle.addEventListener('click', () => {
            if (advancedSettings.style.display === 'block') {
                advancedSettings.style.display = 'none';
                advancedToggle.textContent = 'æ˜¾ç¤ºé«˜çº§è®¾ç½® â–¼';
            } else {
                advancedSettings.style.display = 'block';
                advancedToggle.textContent = 'éšè—é«˜çº§è®¾ç½® â–²';
            }
        });

        // åˆ‡æ¢é€‰æ‹©æ¨¡å¼
        selectionModeCheckbox.addEventListener('change', () => {
            selectionMode = selectionModeCheckbox.checked;

            if (selectionMode) {
                bulkControls.classList.add('visible');
                chatContainer.querySelectorAll('.message').forEach(msg => {
                    msg.style.cursor = 'pointer';
                });
            } else {
                bulkControls.classList.remove('visible');
                selectedMessages.clear();
                updateSelectedCount();
                chatContainer.querySelectorAll('.message').forEach(msg => {
                    msg.style.cursor = '';
                    msg.classList.remove('selected');
                });
            }
        });

        // å–æ¶ˆé€‰æ‹©
        cancelSelectButton.addEventListener('click', () => {
            selectionModeCheckbox.checked = false;
            selectionMode = false;
            bulkControls.classList.remove('visible');
            selectedMessages.clear();
            updateSelectedCount();
            chatContainer.querySelectorAll('.message').forEach(msg => {
                msg.style.cursor = '';
                msg.classList.remove('selected');
            });
        });

        // æ‰¹é‡åˆ é™¤
        bulkDeleteButton.addEventListener('click', () => {
            if (selectedMessages.size === 0) return;

            showConfirmDialog(
                'ç¡®è®¤åˆ é™¤',
                `ç¡®å®šè¦åˆ é™¤å·²é€‰æ‹©çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`,
                (confirmed) => {
                    if (confirmed) {
                        deleteSelectedMessages();
                    }
                }
            );
        });

        // æ›´æ–°é€‰ä¸­æ•°é‡
        function updateSelectedCount() {
            selectedCount.textContent = `å·²é€‰æ‹© ${selectedMessages.size} æ¡æ¶ˆæ¯`;
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½é…ç½®
        function loadConfig() {
            const savedApiUrl = localStorage.getItem('apiUrl');
            const savedApiKey = localStorage.getItem('apiKey');
            const savedModel = localStorage.getItem('model');
            const savedTemp = localStorage.getItem('temperature');
            const savedStream = localStorage.getItem('stream');
            const savedDirection = localStorage.getItem('textDirection');
            const savedSystemPrompt = localStorage.getItem('systemPrompt');
            const savedMaxTokens = localStorage.getItem('maxTokens');
            const savedContextLength = localStorage.getItem('contextLength');

            if (savedApiUrl) apiUrlInput.value = savedApiUrl;
            if (savedApiKey) apiKeyInput.value = savedApiKey;
            if (savedModel) modelSelect.value = savedModel;
            if (savedTemp) {
                tempSlider.value = savedTemp;
                tempValue.textContent = savedTemp;
            }
            if (savedStream !== null) streamCheckbox.checked = savedStream === 'true';
            if (savedDirection) textDirectionSelect.value = savedDirection;
            if (savedSystemPrompt) systemPrompt.value = savedSystemPrompt;
            if (savedMaxTokens) maxTokens.value = savedMaxTokens;
            if (savedContextLength) {
                contextLength.value = savedContextLength;
                contextLengthDesc.textContent = `ä¿ç•™æœ€è¿‘${savedContextLength}æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡`;
            }

            // åŠ è½½å¯¹è¯å†å²
            const savedHistory = localStorage.getItem('conversationHistory');
            if (savedHistory) {
                try {
                    const parsedHistory = JSON.parse(savedHistory);

                    // ä¸ºæ¯æ¡æ¶ˆæ¯æ·»åŠ IDï¼Œå¦‚æœæ²¡æœ‰çš„è¯
                    conversationHistory = parsedHistory.map(msg => {
                        if (!msg.id && msg.role !== 'system') {
                            msg.id = generateMessageId();
                        }
                        return msg;
                    });

                    // é‡å»ºèŠå¤©ç•Œé¢
                    conversationHistory.forEach(msg => {
                        if (msg.role === 'system') return; // ä¸æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                        addMessageToUI(msg.role, msg.content, msg.id, msg.originalContent);
                    });
                } catch (e) {
                    console.error('æ— æ³•åŠ è½½å†å²å¯¹è¯:', e);
                }
            }
        }

        // ç”Ÿæˆæ¶ˆæ¯ID
        function generateMessageId() {
            return `msg_${Date.now()}_${messageCounter++}`;
        }

        // ä¿å­˜é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
        function saveConfig() {
            localStorage.setItem('apiUrl', apiUrlInput.value);
            localStorage.setItem('apiKey', apiKeyInput.value);
            localStorage.setItem('model', modelSelect.value);
            localStorage.setItem('temperature', tempSlider.value);
            localStorage.setItem('stream', streamCheckbox.checked);
            localStorage.setItem('textDirection', textDirectionSelect.value);
            localStorage.setItem('systemPrompt', systemPrompt.value);
            localStorage.setItem('maxTokens', maxTokens.value);
            localStorage.setItem('contextLength', contextLength.value);

            // ä¿å­˜å¯¹è¯å†å²
            localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            statusMessage.className = type === 'error' ? 'error-message' : 'success-message';
            statusMessage.textContent = message;
            setTimeout(() => {
                statusMessage.textContent = '';
            }, 3000);
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopyToast() {
            copyToast.style.opacity = '1';
            setTimeout(() => {
                copyToast.style.opacity = '0';
            }, 2000);
        }

        // æ£€æµ‹æ–‡æœ¬æ–¹å‘
        function detectTextDirection(text) {
            // å¦‚æœåŒ…å«RTLå­—ç¬¦ï¼Œè¿”å›rtlï¼Œå¦åˆ™è¿”å›ltr
            return rtlRegex.test(text) ? 'rtl' : 'ltr';
        }

        // åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
        function deleteSelectedMessages() {
            // å°†Setè½¬ä¸ºArrayï¼Œä»¥é˜²åœ¨éå†è¿‡ç¨‹ä¸­ä¿®æ”¹Set
            const idsToDelete = Array.from(selectedMessages);

            // æŒ‰ç…§IDåˆ é™¤æ¶ˆæ¯
            idsToDelete.forEach(id => {
                deleteMessage(id);
            });

            // æ¸…ç©ºé€‰ä¸­é›†åˆ
            selectedMessages.clear();
            updateSelectedCount();

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„æ¶ˆæ¯äº†ï¼Œå¯ä»¥è€ƒè™‘é€€å‡ºé€‰æ‹©æ¨¡å¼
            if (selectionModeCheckbox.checked && selectedMessages.size === 0) {
                selectionModeCheckbox.checked = false;
                selectionMode = false;
                bulkControls.classList.remove('visible');
            }

            showStatus(`å·²åˆ é™¤ ${idsToDelete.length} æ¡æ¶ˆæ¯`, 'success');

            // ä¿å­˜æ›´æ–°åçš„å¯¹è¯å†å²
            saveConfig();
        }

        // åˆ é™¤å•æ¡æ¶ˆæ¯
        function deleteMessage(messageId) {
            // ä»DOMä¸­ç§»é™¤
            const messageElement = messageElements.get(messageId);
            if (messageElement) {
                messageElement.classList.add('deleting');
                setTimeout(() => {
                    messageElement.remove();
                    messageElements.delete(messageId);
                }, 300); // åŠ¨ç”»æ—¶é—´
            }

            // ä»å†å²è®°å½•ä¸­ç§»é™¤
            const messageIndex = conversationHistory.findIndex(msg => msg.id === messageId);
            if (messageIndex !== -1) {
                conversationHistory.splice(messageIndex, 1);
            }

            // å¦‚æœè¯¥æ¶ˆæ¯åœ¨é€‰ä¸­é›†åˆä¸­ï¼Œç§»é™¤å®ƒ
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
                updateSelectedCount();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°UI
        function addMessageToUI(role, content, messageId = null, originalContent = null) {
            if (!messageId) {
                messageId = generateMessageId();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.dataset.id = messageId;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ç”¨æˆ·' : 'AI';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // æ ¹æ®è®¾ç½®æˆ–è‡ªåŠ¨æ£€æµ‹å†³å®šæ–‡å­—æ–¹å‘
            const direction = textDirectionSelect.value;

            // åº”ç”¨æ–‡å­—æ–¹å‘
            if (direction === 'rtl' || (direction === 'auto' && detectTextDirection(content) === 'rtl')) {
                contentDiv.classList.add('rtl');
            }

            // æ ¹æ®è§’è‰²å¤„ç†å†…å®¹
            if (role === 'assistant') {
                // ä½¿ç”¨Markdownè§£æå™¨å¤„ç†AIå›å¤
                contentDiv.innerHTML = marked.parse(content);
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ä¸éœ€è¦Markdownè§£æ
                contentDiv.textContent = content;
            }

            // æ·»åŠ æ—¶é—´æˆ³
            const timestamp = document.createElement('div');
            timestamp.className = 'message-timestamp';
            timestamp.textContent = new Date().toLocaleTimeString();
            contentDiv.appendChild(timestamp);

            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.innerHTML = 'Ã—';
            deleteButton.title = 'åˆ é™¤æ­¤æ¶ˆæ¯';
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œä»¥é˜²è§¦å‘æ¶ˆæ¯é€‰æ‹©

                showConfirmDialog(
                    'ç¡®è®¤åˆ é™¤',
                    'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ',
                    (confirmed) => {
                        if (confirmed) {
                            deleteMessage(messageId);
                            saveConfig();
                        }
                    }
                );
            });

            // æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆåªç»™ç”¨æˆ·æ¶ˆæ¯æ·»åŠ ï¼‰
            if (role === 'user') {
                const editButton = document.createElement('button');
                editButton.className = 'edit-button';
                editButton.innerHTML = 'âœ';
                editButton.title = 'ç¼–è¾‘æ­¤æ¶ˆæ¯';
                editButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                    editMessage(messageId);
                });
                messageDiv.appendChild(editButton);
            }

            // æ·»åŠ é‡æ–°å‘é€æŒ‰é’®ï¼ˆåªç»™ç”¨æˆ·æ¶ˆæ¯æ·»åŠ ï¼‰
            if (role === 'user') {
                const resendButton = document.createElement('button');
                resendButton.className = 'resend-button';
                resendButton.innerHTML = 'â†»';
                resendButton.title = 'é‡æ–°å‘é€æ­¤æ¶ˆæ¯';
                resendButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                    resendMessage(messageId);
                });
                messageDiv.appendChild(resendButton);
            }

            // æ·»åŠ æ“ä½œæŒ‰é’®å®¹å™¨ (åªç»™AIå›å¤æ·»åŠ )
            if (role === 'assistant') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';

                // å¤åˆ¶æŒ‰é’®
                const copyButton = document.createElement('button');
                copyButton.className = 'action-btn';
                copyButton.textContent = 'å¤åˆ¶';
                copyButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢å†’æ³¡

                    // æå–çº¯æ–‡æœ¬ï¼ˆä¸å«Markdownæ ‡è®°å’Œæ—¶é—´æˆ³ï¼‰
                    const plainText = extractPlainText(contentDiv.innerHTML);

                    navigator.clipboard.writeText(plainText)
                        .then(() => {
                            showCopyToast();
                        })
                        .catch(err => {
                            console.error('å¤åˆ¶å¤±è´¥:', err);
                            showStatus('å¤åˆ¶å¤±è´¥', 'error');
                        });
                });

                // æœ—è¯»æŒ‰é’®ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
                if ('speechSynthesis' in window) {
                    const speakButton = document.createElement('button');
                    speakButton.className = 'action-btn';
                    speakButton.textContent = 'æœ—è¯»';
                    speakButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                        // åœæ­¢æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
                        window.speechSynthesis.cancel();

                        // ä½¿ç”¨æå–çš„çº¯æ–‡æœ¬è¿›è¡Œæœ—è¯»
                        const plainText = extractPlainText(contentDiv.innerHTML);
                        const utterance = new SpeechSynthesisUtterance(plainText);

                        // å¦‚æœæ˜¯RTLæ–‡æœ¬ï¼Œå°è¯•è®¾ç½®åˆé€‚çš„è¯­è¨€
                        if (contentDiv.classList.contains('rtl')) {
                            utterance.lang = 'ar'; // é»˜è®¤ä½¿ç”¨é˜¿æ‹‰ä¼¯è¯­ï¼Œå› ä¸ºå¤§å¤šæ•°æµè§ˆå™¨æ”¯æŒ
                        }
                        window.speechSynthesis.speak(utterance);
                    });
                    actionsDiv.appendChild(speakButton);
                }

                actionsDiv.appendChild(copyButton);
                contentDiv.appendChild(actionsDiv);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(deleteButton);

            // æ·»åŠ é€‰æ‹©æ¶ˆæ¯çš„åŠŸèƒ½
            messageDiv.addEventListener('click', () => {
                if (!selectionMode) return;

                if (selectedMessages.has(messageId)) {
                    selectedMessages.delete(messageId);
                    messageDiv.classList.remove('selected');
                } else {
                    selectedMessages.add(messageId);
                    messageDiv.classList.add('selected');
                }

                updateSelectedCount();
            });

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // ä¿å­˜æ¶ˆæ¯å…ƒç´ å¼•ç”¨
            messageElements.set(messageId, messageDiv);

            return { contentDiv, messageId, originalContent };
        }

        function processMessageContent(contentDiv) {
            // å¤„ç†æ‰€æœ‰å›¾ç‰‡å…ƒç´ ï¼Œæ— è®ºå…¶æ ¼å¼
            const images = contentDiv.querySelectorAll('img');
            images.forEach(img => {
                // è®¾ç½®å†…è”æ ·å¼ç¡®ä¿é™åˆ¶å°ºå¯¸
                img.style.maxWidth = '30%';
                img.style.height = 'auto';
                img.style.maxHeight = '300px';
                img.style.objectFit = 'contain';

                // æ·»åŠ åŠ è½½äº‹ä»¶å¤„ç†ç¨‹åº
                img.addEventListener('load', function () {
                    // å›¾ç‰‡åŠ è½½å®Œæˆåé‡æ–°æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
            });
        }

        // ç¼–è¾‘æ¶ˆæ¯
        function editMessage(messageId) {
            const message = conversationHistory.find(msg => msg.id === messageId);
            if (!message || message.role !== 'user') return;

            // è®¾ç½®å½“å‰ç¼–è¾‘çš„æ¶ˆæ¯ID
            currentEditingMessageId = messageId;

            // å¦‚æœæœ‰åŸå§‹å†…å®¹ï¼ˆåŒ…å«æ–‡ä»¶é“¾æ¥ï¼‰ï¼Œä½¿ç”¨å®ƒ
            const contentToEdit = message.originalContent || message.content;

            // å°†å†…å®¹å¡«å…¥è¾“å…¥æ¡†
            messageInput.value = contentToEdit;
            messageInput.focus();

            // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
            autoResizeTextarea(messageInput);

            // æ›´æ”¹å‘é€æŒ‰é’®æ–‡æœ¬
            sendButton.textContent = 'æ›´æ–°';

            // æç¤ºç”¨æˆ·æ­£åœ¨ç¼–è¾‘
            showStatus('æ­£åœ¨ç¼–è¾‘æ¶ˆæ¯ï¼ŒæŒ‰æ›´æ–°ä¿å­˜ä¿®æ”¹', 'info');
        }

        // é‡æ–°å‘é€æ¶ˆæ¯
        function resendMessage(messageId) {
            const message = conversationHistory.find(msg => msg.id === messageId);
            if (!message || message.role !== 'user') return;

            // æ‰¾åˆ°è¿™æ¡æ¶ˆæ¯åé¢çš„æ‰€æœ‰æ¶ˆæ¯
            const messageIndex = conversationHistory.findIndex(msg => msg.id === messageId);
            if (messageIndex === -1) return;

            // ç¡®è®¤é‡æ–°å‘é€
            showConfirmDialog(
                'ç¡®è®¤é‡æ–°å‘é€',
                'é‡æ–°å‘é€æ­¤æ¶ˆæ¯å°†åˆ é™¤æ­¤æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰å¯¹è¯ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ',
                async (confirmed) => {
                    if (confirmed) {
                        // åˆ é™¤æ­¤æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆä»DOMå’Œå†å²è®°å½•ä¸­ï¼‰
                        for (let i = conversationHistory.length - 1; i > messageIndex; i--) {
                            const msgToDelete = conversationHistory[i];
                            deleteMessage(msgToDelete.id);
                        }

                        // è·å–åŸå§‹å†…å®¹æˆ–æ™®é€šå†…å®¹
                        const contentToResend = message.originalContent || message.content;

                        // åˆ é™¤å½“å‰æ¶ˆæ¯
                        deleteMessage(messageId);

                        // é‡æ–°å‘é€
                        messageInput.value = contentToResend;

                        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
                        autoResizeTextarea(messageInput);

                        await sendMessage();
                    }
                }
            );
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(role, content, originalContent = null) {
            const messageId = generateMessageId();
            const { contentDiv } = addMessageToUI(role, content, messageId, originalContent);

            // æ·»åŠ åˆ°å†å²
            conversationHistory.push({
                role,
                content,
                id: messageId,
                originalContent
            });

            return { contentDiv, messageId };
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            showConfirmDialog(
                'ç¡®è®¤æ¸…ç©º',
                'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿè¿™å°†æ— æ³•æ¢å¤ï¼',
                (confirmed) => {
                    if (confirmed) {
                        chatContainer.innerHTML = '';
                        conversationHistory = [];
                        messageElements.clear();

                        // å¦‚æœæœ‰ç³»ç»Ÿæç¤ºï¼Œä¿ç•™å®ƒ
                        const sysPrompt = systemPrompt.value.trim();
                        if (sysPrompt) {
                            conversationHistory.push({ role: 'system', content: sysPrompt });
                        }

                        // æ¸…ç©ºå·²ä¸Šä¼ çš„æ–‡ä»¶
                        uploadedFiles = [];
                        uploadedFileUrls = [];
                        filePreview.innerHTML = '';
                        updateAttachmentIndicator();

                        saveConfig();
                        showStatus('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
                    }
                }
            );
        }

        // å¯¼å‡ºå¯¹è¯
        function exportChat() {
            // æ’é™¤ç³»ç»Ÿæ¶ˆæ¯
            const exportHistory = conversationHistory.filter(msg => msg.role !== 'system');

            // æ ¼å¼åŒ–å¯¹è¯å†…å®¹
            let exportContent = '# èŠå¤©è®°å½•\n\n';
            exportHistory.forEach(msg => {
                const roleText = msg.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹';

                // æå–çº¯æ–‡æœ¬å†…å®¹ï¼Œä¸åŒ…å«æ—¶é—´æˆ³
                let content = msg.content;
                if (msg.role === 'assistant') {
                    // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥è§£æMarkdownå¹¶è·å–çº¯æ–‡æœ¬
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = marked.parse(content);

                    // ç§»é™¤æ—¶é—´æˆ³
                    const timestamps = tempDiv.querySelectorAll('.message-timestamp');
                    timestamps.forEach(el => el.remove());

                    content = tempDiv.textContent || tempDiv.innerText || content;
                }

                exportContent += `## ${roleText}\n\n${content}\n\n`;
            });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([exportContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.href = url;
            a.download = `èŠå¤©è®°å½•_${timestamp}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('èŠå¤©è®°å½•å·²å¯¼å‡º', 'success');
        }

        // åœæ­¢ç”Ÿæˆ
        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;

                isGenerating = false;
                sendButton.disabled = false;
                sendButton.innerHTML = 'å‘é€';
                stopButton.style.display = 'none';

                showStatus('å·²åœæ­¢ç”Ÿæˆ', 'success');
            }
        }

        // å‡†å¤‡å‘é€åˆ°APIçš„ä¸Šä¸‹æ–‡
        function prepareContext() {
            // å¤åˆ¶ä¸€ä»½å†å²è®°å½•
            let context = [...conversationHistory];

            // è·å–è®¾å®šçš„ä¸Šä¸‹æ–‡é•¿åº¦
            const maxContextLength = parseInt(contextLength.value);

            // ç¡®ä¿ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯
            let systemMessages = context.filter(msg => msg.role === 'system');

            // è·å–ç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯
            let conversationMessages = context.filter(msg => msg.role !== 'system');

            // å¦‚æœå¯¹è¯æ¶ˆæ¯è¶…å‡ºä¸Šä¸‹æ–‡é•¿åº¦ï¼Œåªä¿ç•™æœ€è¿‘çš„maxContextLengthæ¡
            if (conversationMessages.length > maxContextLength) {
                conversationMessages = conversationMessages.slice(-maxContextLength);
            }

            // åˆå¹¶ç³»ç»Ÿæ¶ˆæ¯å’Œè£å‰ªåçš„å¯¹è¯æ¶ˆæ¯
            context = [...systemMessages, ...conversationMessages];

            // æ¸…é™¤IDç­‰éAPIéœ€è¦çš„å­—æ®µ
            return context.map(({ role, content }) => ({ role, content }));
        }

        // å¤„ç†APIé”™è¯¯
        function handleAPIError(error, messageId, contentDiv) {
            // å¦‚æœæ˜¯ä¸­æ­¢é”™è¯¯ï¼Œç‰¹æ®Šå¤„ç†
            if (error.name === 'AbortError') {
                for (let i = 0; i < conversationHistory.length; i++) {
                    if (conversationHistory[i].id === messageId) {
                        conversationHistory[i].content += "\n\n[å·²åœæ­¢ç”Ÿæˆ]";
                        contentDiv.innerHTML += "<p><em>[å·²åœæ­¢ç”Ÿæˆ]</em></p>";
                        break;
                    }
                }
                return;
            }

            console.error('Error:', error);
            contentDiv.innerHTML = '<p class="error">å‘ç”Ÿé”™è¯¯: ' + error.message + '</p>';

            // æ·»åŠ é‡è¯•æŒ‰é’®
            const retryButton = document.createElement('button');
            retryButton.className = 'action-btn';
            retryButton.textContent = 'é‡è¯•';
            retryButton.style.marginTop = '10px';
            retryButton.addEventListener('click', () => {
                // æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                const userMessages = conversationHistory.filter(msg => msg.role === 'user');
                if (userMessages.length > 0) {
                    const lastUserMsg = userMessages[userMessages.length - 1];

                    // åˆ é™¤é”™è¯¯çš„AIå›å¤
                    deleteMessage(messageId);

                    // å‘é€è¯·æ±‚
                    sendAPIRequest(lastUserMsg.content);
                }
            });

            contentDiv.appendChild(retryButton);
            showStatus('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
        }

        // å‘é€APIè¯·æ±‚çš„æ ¸å¿ƒå‡½æ•°
        async function sendAPIRequest(userMessageContent, existingMessageId = null, existingContentDiv = null) {
            const apiKey = apiKeyInput.value.trim();
            const apiUrl = apiUrlInput.value.trim();

            if (!apiKey || !apiUrl) {
                showStatus('APIé…ç½®ä¸å®Œæ•´', 'error');
                return;
            }

            // å‡†å¤‡å‘é€åˆ°APIçš„æ¶ˆæ¯å†å² (å¸¦æœ‰ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶)
            const apiMessages = prepareContext();

            // å¦‚æœæ²¡æœ‰ç°æœ‰çš„æ¶ˆæ¯IDå’Œå†…å®¹DIVï¼Œåˆ›å»ºæ–°çš„
            let messageId = existingMessageId;
            let contentDiv = existingContentDiv;

            if (!messageId || !contentDiv) {
                const { contentDiv: newContentDiv, messageId: newMessageId } = addMessage('assistant', '');
                contentDiv = newContentDiv;
                messageId = newMessageId;
            }

            try {
                const isStream = streamCheckbox.checked;

                // å‡†å¤‡è¯·æ±‚ä½“
                const requestBody = {
                    model: modelSelect.value,
                    messages: apiMessages,
                    temperature: parseFloat(tempSlider.value),
                    max_tokens: parseInt(maxTokens.value),
                    stream: isStream
                };

                // åˆ›å»ºAbortControllerç”¨äºä¸­æ­¢è¯·æ±‚
                abortController = new AbortController();

                if (isStream) {
                    // æµå¼è¯·æ±‚
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: abortController.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantMessage = '';
                    let markdownContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;

                                try {
                                    const json = JSON.parse(data);
                                    const content = json.choices[0]?.delta?.content || '';
                                    assistantMessage += content;
                                    markdownContent = assistantMessage;

                                    // ä½¿ç”¨Markdownè§£æå™¨æ¸²æŸ“å†…å®¹
                                    contentDiv.innerHTML = marked.parse(markdownContent);
                                    processMessageContent(contentDiv);

                                    // æ£€æµ‹å¹¶åº”ç”¨æ–‡å­—æ–¹å‘
                                    const direction = textDirectionSelect.value;
                                    if (direction === 'rtl') {
                                        contentDiv.classList.add('rtl');
                                    } else if (direction === 'auto' && detectTextDirection(assistantMessage) === 'rtl') {
                                        contentDiv.classList.add('rtl');
                                    } else {
                                        contentDiv.classList.remove('rtl');
                                    }

                                    // åŠ¨æ€æ·»åŠ æ“ä½œæŒ‰é’®
                                    if (!contentDiv.querySelector('.message-actions')) {
                                        const actionsDiv = document.createElement('div');
                                        actionsDiv.className = 'message-actions';

                                        // å¤åˆ¶æŒ‰é’®
                                        const copyButton = document.createElement('button');
                                        copyButton.className = 'action-btn';
                                        copyButton.textContent = 'å¤åˆ¶';
                                        copyButton.addEventListener('click', (e) => {
                                            e.stopPropagation(); // é˜»æ­¢å†’æ³¡

                                            // æå–çº¯æ–‡æœ¬ï¼ˆä¸å«Markdownæ ‡è®°å’Œæ—¶é—´æˆ³ï¼‰
                                            const plainText = extractPlainText(contentDiv.innerHTML);

                                            navigator.clipboard.writeText(plainText)
                                                .then(() => showCopyToast())
                                                .catch(err => showStatus('å¤åˆ¶å¤±è´¥', 'error'));
                                        });

                                        // æœ—è¯»æŒ‰é’®
                                        if ('speechSynthesis' in window) {
                                            const speakButton = document.createElement('button');
                                            speakButton.className = 'action-btn';
                                            speakButton.textContent = 'æœ—è¯»';
                                            speakButton.addEventListener('click', (e) => {
                                                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                                                window.speechSynthesis.cancel();

                                                // è·å–çº¯æ–‡æœ¬ç”¨äºæœ—è¯»
                                                const plainText = extractPlainText(contentDiv.innerHTML);
                                                const utterance = new SpeechSynthesisUtterance(plainText);

                                                if (contentDiv.classList.contains('rtl')) {
                                                    utterance.lang = 'ar';
                                                }
                                                window.speechSynthesis.speak(utterance);
                                            });
                                            actionsDiv.appendChild(speakButton);
                                        }

                                        actionsDiv.appendChild(copyButton);
                                        contentDiv.appendChild(actionsDiv);

                                        // æ·»åŠ æ—¶é—´æˆ³
                                        const timestamp = document.createElement('div');
                                        timestamp.className = 'message-timestamp';
                                        timestamp.textContent = new Date().toLocaleTimeString();
                                        contentDiv.appendChild(timestamp);
                                    }

                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                } catch (e) {
                                    console.error('Parse error:', e);
                                }
                            }
                        }
                    }

                    // æ›´æ–°å†å²ä¸­çš„æ¶ˆæ¯å†…å®¹
                    for (let i = 0; i < conversationHistory.length; i++) {
                        if (conversationHistory[i].id === messageId) {
                            conversationHistory[i].content = assistantMessage;
                            break;
                        }
                    }

                } else {
                    // éæµå¼è¯·æ±‚
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: abortController.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const assistantMessage = data.choices[0].message.content;

                    // ä½¿ç”¨Markdownè§£æå™¨æ¸²æŸ“å†…å®¹
                    contentDiv.innerHTML = marked.parse(assistantMessage);
                    processMessageContent(contentDiv);

                    // æ£€æµ‹å¹¶åº”ç”¨æ–‡å­—æ–¹å‘
                    const direction = textDirectionSelect.value;
                    if (direction === 'rtl') {
                        contentDiv.classList.add('rtl');
                    } else if (direction === 'auto' && detectTextDirection(assistantMessage) === 'rtl') {
                        contentDiv.classList.add('rtl');
                    } else {
                        contentDiv.classList.remove('rtl');
                    }

                    // æ·»åŠ æ“ä½œæŒ‰é’®
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';

                    // å¤åˆ¶æŒ‰é’®
                    const copyButton = document.createElement('button');
                    copyButton.className = 'action-btn';
                    copyButton.textContent = 'å¤åˆ¶';
                    copyButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜»æ­¢å†’æ³¡

                        // æå–çº¯æ–‡æœ¬ï¼ˆä¸å«Markdownæ ‡è®°å’Œæ—¶é—´æˆ³ï¼‰
                        const plainText = extractPlainText(contentDiv.innerHTML);

                        navigator.clipboard.writeText(plainText)
                            .then(() => showCopyToast())
                            .catch(err => showStatus('å¤åˆ¶å¤±è´¥', 'error'));
                    });

                    // æœ—è¯»æŒ‰é’®
                    if ('speechSynthesis' in window) {
                        const speakButton = document.createElement('button');
                        speakButton.className = 'action-btn';
                        speakButton.textContent = 'æœ—è¯»';
                        speakButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                            window.speechSynthesis.cancel();

                            // è·å–çº¯æ–‡æœ¬ç”¨äºæœ—è¯»
                            const plainText = extractPlainText(contentDiv.innerHTML);
                            const utterance = new SpeechSynthesisUtterance(plainText);

                            if (contentDiv.classList.contains('rtl')) {
                                utterance.lang = 'ar';
                            }
                            window.speechSynthesis.speak(utterance);
                        });
                        actionsDiv.appendChild(speakButton);
                    }

                    actionsDiv.appendChild(copyButton);
                    contentDiv.appendChild(actionsDiv);

                    // æ·»åŠ æ—¶é—´æˆ³
                    const timestamp = document.createElement('div');
                    timestamp.className = 'message-timestamp';
                    timestamp.textContent = new Date().toLocaleTimeString();
                    contentDiv.appendChild(timestamp);

                    // æ›´æ–°å†å²ä¸­çš„æ¶ˆæ¯å†…å®¹
                    for (let i = 0; i < conversationHistory.length; i++) {
                        if (conversationHistory[i].id === messageId) {
                            conversationHistory[i].content = assistantMessage;
                            break;
                        }
                    }
                }

                // ä¿å­˜å¯¹è¯å†å²åˆ°æœ¬åœ°å­˜å‚¨
                saveConfig();

                return true; // è¯·æ±‚æˆåŠŸ
            } catch (error) {
                handleAPIError(error, messageId, contentDiv);
                return false; // è¯·æ±‚å¤±è´¥
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();

            // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯æˆ–é™„ä»¶
            if (!message && uploadedFileUrls.length === 0) return;

            const apiKey = apiKeyInput.value.trim();
            const apiUrl = apiUrlInput.value.trim();

            if (!apiKey) {
                showStatus('è¯·è¾“å…¥API Key', 'error');
                return;
            }

            if (!apiUrl) {
                showStatus('è¯·è¾“å…¥APIåœ°å€', 'error');
                return;
            }

            // ä¿å­˜é…ç½®
            saveConfig();

            // å¤„ç†ç¼–è¾‘æ¨¡å¼
            if (currentEditingMessageId) {
                // æŸ¥æ‰¾æ­£åœ¨ç¼–è¾‘çš„æ¶ˆæ¯
                const messageIndex = conversationHistory.findIndex(msg => msg.id === currentEditingMessageId);
                if (messageIndex !== -1) {
                    // è·å–æ¶ˆæ¯å…ƒç´ 
                    const messageElement = messageElements.get(currentEditingMessageId);
                    if (messageElement) {
                        // æ›´æ–°DOM
                        const contentDiv = messageElement.querySelector('.message-content');
                        contentDiv.textContent = message;

                        // æ›´æ–°å†å²è®°å½•
                        conversationHistory[messageIndex].content = message;

                        // é‡ç½®ç¼–è¾‘çŠ¶æ€
                        currentEditingMessageId = null;
                        sendButton.textContent = 'å‘é€';

                        // æ¸…ç©ºè¾“å…¥æ¡†
                        messageInput.value = '';
                        messageInput.style.height = 'auto'; // é‡ç½®é«˜åº¦

                        // ä¿å­˜æ›´æ–°
                        saveConfig();

                        showStatus('æ¶ˆæ¯å·²æ›´æ–°', 'success');
                        return;
                    }
                }
            }

            // ç¦ç”¨è¾“å…¥å¹¶æ˜¾ç¤ºåœæ­¢æŒ‰é’®
            isGenerating = true;
            messageInput.value = '';
            messageInput.style.height = 'auto'; // é‡ç½®é«˜åº¦
            sendButton.disabled = true;
            sendButton.innerHTML = 'ç”Ÿæˆä¸­<span class="loading"></span>';
            stopButton.style.display = 'inline-block';

            // æ„å»ºå¸¦æœ‰æ–‡ä»¶URLçš„æ¶ˆæ¯
            let userMessageContent = message;
            let fileUrlsText = '';
            let apiMessageContent = message;

            if (uploadedFileUrls.length > 0) {
                // å°†æ‰€æœ‰æ–‡ä»¶URLæ·»åŠ åˆ°æ¶ˆæ¯å‰é¢ï¼Œæ¯ä¸ªURLåé¢åŠ ä¸€ä¸ªç©ºæ ¼
                fileUrlsText = uploadedFileUrls.map(fileObj => fileObj.url).join(' ') + ' ';

                // æ·»åŠ æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯
                const fileNames = uploadedFileUrls.map(fileObj => fileObj.filename).join(', ');

                // åœ¨UIä¸­æ˜¾ç¤ºçš„æ¶ˆæ¯æ·»åŠ é™„ä»¶è¯´æ˜
                userMessageContent = message + (message ? '\n\n' : '') + `[é™„ä»¶: ${fileNames}]`;

                // APIå‘é€çš„æ¶ˆæ¯åŒ…å«æ–‡ä»¶URLå’Œç”¨æˆ·è¾“å…¥
                apiMessageContent = fileUrlsText + message;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°UI
            const userMessageId = addMessage('user', userMessageContent, apiMessageContent).messageId;

            // å¤„ç†ç³»ç»Ÿæç¤º
            const sysPrompt = systemPrompt.value.trim();

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç³»ç»Ÿæ¶ˆæ¯
            let hasSystemMsg = false;
            for (let i = 0; i < conversationHistory.length; i++) {
                if (conversationHistory[i].role === 'system') {
                    if (sysPrompt) {
                        conversationHistory[i].content = sysPrompt;
                    } else {
                        conversationHistory.splice(i, 1);
                    }
                    hasSystemMsg = true;
                    break;
                }
            }

            // å¦‚æœæ²¡æœ‰ç³»ç»Ÿæ¶ˆæ¯ä½†æœ‰ç³»ç»Ÿæç¤ºï¼Œæ·»åŠ å®ƒ
            if (!hasSystemMsg && sysPrompt) {
                conversationHistory.unshift({ role: 'system', content: sysPrompt });
            }

            // æ›´æ–°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„å†…å®¹ä¸ºAPIæ ¼å¼
            const userMessageIndex = conversationHistory.findIndex(msg => msg.id === userMessageId);
            if (userMessageIndex !== -1) {
                conversationHistory[userMessageIndex].content = apiMessageContent;
            }

            // å‘é€APIè¯·æ±‚
            await sendAPIRequest(apiMessageContent);

            // æ— è®ºè¯·æ±‚æˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½æ‰§è¡Œä»¥ä¸‹æ“ä½œ
            isGenerating = false;
            sendButton.disabled = false;
            sendButton.innerHTML = 'å‘é€';
            stopButton.style.display = 'none';
            abortController = null;
            messageInput.focus();

            // æ¸…ç©ºå·²ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå› ä¸ºå·²ç»å‘é€äº†
            uploadedFiles = [];
            uploadedFileUrls = [];
            filePreview.innerHTML = '';
            updateAttachmentIndicator();

            // éšè—æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            fileUploadContainer.classList.remove('active');
        }

        // äº‹ä»¶ç›‘å¬å™¨
        tempSlider.addEventListener('input', (e) => {
            tempValue.textContent = e.target.value;
        });

        sendButton.addEventListener('click', sendMessage);
        stopButton.addEventListener('click', stopGeneration);
        clearButton.addEventListener('click', clearChat);
        exportButton.addEventListener('click', exportChat);

        // æ›´æ–°é”®ç›˜äº‹ä»¶å¤„ç†ï¼Œæ”¯æŒShift+Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !isGenerating) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæ·»åŠ æ–°è¡Œï¼‰
                sendMessage();
            }
            // å¦‚æœæ˜¯Shift+Enterï¼Œå…è®¸é»˜è®¤è¡Œä¸ºï¼ˆæ·»åŠ æ–°è¡Œï¼‰
        });

        // æ–‡å­—æ–¹å‘æ›´æ”¹äº‹ä»¶
        textDirectionSelect.addEventListener('change', () => {
            const direction = textDirectionSelect.value;
            // åº”ç”¨åˆ°æ‰€æœ‰ç°æœ‰æ¶ˆæ¯
            document.querySelectorAll('.message-content').forEach(element => {
                if (direction === 'rtl') {
                    element.classList.add('rtl');
                } else if (direction === 'ltr') {
                    element.classList.remove('rtl');
                } else {
                    // auto - æ ¹æ®å†…å®¹æ£€æµ‹
                    const content = element.textContent;
                    if (detectTextDirection(content) === 'rtl') {
                        element.classList.add('rtl');
                    } else {
                        element.classList.remove('rtl');
                    }
                }
            });
            saveConfig();
        });

        // åˆå§‹åŒ–
        loadConfig();
        messageInput.focus();
    </script>
</body>

</html>
