<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR码扫描与拼接工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }
        h1 {
            text-align: center;
            color: #0066cc;
            margin-bottom: 5px;
        }
        .description {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            background: #f7f9fc;
            padding: 12px 15px;
            border-bottom: 1px solid #eaecef;
            font-weight: bold;
        }
        .card-body {
            padding: 15px;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            margin-bottom: 10px;
        }
        .btn:active {
            background: #0052a3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:active {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:active {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:active {
            background: #c82333;
        }
        #video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%;
            overflow: hidden;
            border-radius: 4px;
            background: #000;
            display: none;
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 70%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }
        #close-scanner {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .block-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .block-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .block-item:last-child {
            border-bottom: none;
        }
        .block-num {
            font-weight: bold;
            color: #0066cc;
        }
        .block-type {
            color: #666;
            font-size: 14px;
        }
        .block-actions {
            display: flex;
            gap: 8px;
        }
        .delete-block {
            background: #f8d7da;
            color: #721c24;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .status-bar {
            padding: 10px;
            text-align: center;
            color: #fff;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: 500;
            display: none;
        }
        .status-success {
            background-color: #28a745;
        }
        .status-error {
            background-color: #dc3545;
        }
        .status-warning {
            background-color: #ffc107;
            color: #333;
        }
        .missing-blocks {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .result-area {
            width: 100%;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
        }
        .canvas-hidden {
            display: none;
        }
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .toolbar .btn {
            margin-bottom: 0;
        }
        .version {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>QR码扫描与拼接工具</h1>
        <p class="description">扫描QR码，自动拼接与解码</p>
        
        <div class="card">
            <div class="card-header">扫描QR码</div>
            <div class="card-body">
                <button id="start-scan" class="btn">开启摄像头扫描</button>
                <button id="manual-input" class="btn btn-secondary">手动输入QR码内容</button>
                <div id="video-container">
                    <video id="video" playsinline></video>
                    <div id="scan-region"></div>
                    <button id="close-scanner">×</button>
                </div>
                <div id="scan-status" style="text-align:center;margin-top:10px;color:#666;">准备就绪，点击按钮开始扫描</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">已扫描内容</div>
            <div class="card-body">
                <div class="block-list" id="blocks-list">
                    <div style="padding:15px;text-align:center;color:#999;">尚未扫描任何内容</div>
                </div>
                <div id="missing-blocks" class="missing-blocks"></div>
                <div class="toolbar">
                    <button id="clear-blocks" class="btn btn-danger">清空所有</button>
                    <button id="merge-blocks" class="btn btn-success">合并内容</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">拼接结果</div>
            <div class="card-body">
                <textarea id="result" class="result-area" readonly placeholder="扫描并合并QR码后，结果将显示在这里..."></textarea>
                <button id="copy-result" class="btn btn-success">复制到剪贴板</button>
            </div>
        </div>
        
        <div id="status" class="status-bar"></div>
        
        <canvas id="canvas" class="canvas-hidden"></canvas>
        
        <div class="version">v1.0.0 - 离线可用版本</div>
    </div>
    
    <!-- 引入jsQR库 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- 引入pako库用于解压缩 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    
    <script>
        // 全局变量
        let blocks = {};              // 存储已扫描的块
        let totalBlocks = 0;          // 总块数
        let videoStream = null;       // 视频流
        let scanning = false;         // 是否正在扫描
        let lastResult = null;        // 上次扫描结果
        let lastResultTime = 0;       // 上次结果时间
        
        // DOM元素
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const videoContainer = document.getElementById('video-container');
        const startScanBtn = document.getElementById('start-scan');
        const manualInputBtn = document.getElementById('manual-input');
        const closeScanner = document.getElementById('close-scanner');
        const blocksList = document.getElementById('blocks-list');
        const missingBlocks = document.getElementById('missing-blocks');
        const clearBlocksBtn = document.getElementById('clear-blocks');
        const mergeBlocksBtn = document.getElementById('merge-blocks');
        const resultArea = document.getElementById('result');
        const copyResultBtn = document.getElementById('copy-result');
        const scanStatus = document.getElementById('scan-status');
        const statusBar = document.getElementById('status');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置事件监听
            startScanBtn.addEventListener('click', startScanner);
            manualInputBtn.addEventListener('click', openManualInput);
            closeScanner.addEventListener('click', stopScanner);
            clearBlocksBtn.addEventListener('click', clearAllBlocks);
            mergeBlocksBtn.addEventListener('click', mergeBlocks);
            copyResultBtn.addEventListener('click', copyResult);
            
            // 尝试从本地存储中恢复数据
            restoreFromStorage();
        });
        
        // 开始扫描器
        function startScanner() {
            // 尝试访问摄像头
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',  // 优先使用后置摄像头
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                })
                .then(function(stream) {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true); // iOS要求
                    video.play();
                    videoContainer.style.display = 'block';
                    startScanBtn.style.display = 'none';
                    manualInputBtn.style.display = 'none';
                    scanning = true;
                    scanStatus.textContent = '正在扫描，请将QR码对准框内...';
                    showStatus('摄像头已开启，对准QR码进行扫描', 'success');
                    
                    // 设置canvas大小
                    requestAnimationFrame(tick);
                })
                .catch(function(error) {
                    console.error('无法访问摄像头:', error);
                    showStatus('无法访问摄像头，请检查权限设置', 'error');
                    
                    // 提供手动输入选项
                    openManualInput();
                });
            } else {
                showStatus('您的浏览器不支持摄像头访问', 'error');
                openManualInput();
            }
        }
        
        // 停止扫描器
        function stopScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            videoContainer.style.display = 'none';
            startScanBtn.style.display = 'block';
            manualInputBtn.style.display = 'block';
            scanning = false;
            scanStatus.textContent = '扫描已停止';
        }
        
        // 处理视频帧
        function tick() {
            if (!scanning) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // 设置canvas大小与视频相匹配
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // 绘制视频帧到canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // 获取图像数据
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // 使用jsQR库进行QR码检测
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                // 如果检测到QR码
                if (code) {
                    // 防止重复扫描同一个码
                    if (lastResult !== code.data || Date.now() - lastResultTime > 2000) {
                        lastResult = code.data;
                        lastResultTime = Date.now();
                        
                        // 处理QR码数据
                        handleQRData(code.data);
                    }
                }
            }
            
            // 继续处理下一帧
            requestAnimationFrame(tick);
        }
        
        // 打开手动输入对话框
        function openManualInput() {
            // 创建对话框
            const dialog = document.createElement('div');
            dialog.style.position = 'fixed';
            dialog.style.top = '0';
            dialog.style.left = '0';
            dialog.style.width = '100%';
            dialog.style.height = '100%';
            dialog.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            dialog.style.display = 'flex';
            dialog.style.justifyContent = 'center';
            dialog.style.alignItems = 'center';
            dialog.style.zIndex = '1000';
            dialog.style.padding = '20px';
            dialog.style.boxSizing = 'border-box';
            
            // 对话框内容
            const content = document.createElement('div');
            content.style.backgroundColor = 'white';
            content.style.padding = '20px';
            content.style.borderRadius = '8px';
            content.style.width = '100%';
            content.style.maxWidth = '400px';
            content.style.boxSizing = 'border-box';
            
            // 标题
            const title = document.createElement('h3');
            title.textContent = '手动输入QR码内容';
            title.style.margin = '0 0 15px 0';
            
            // 输入框
            const input = document.createElement('textarea');
            input.style.width = '100%';
            input.style.height = '120px';
            input.style.padding = '10px';
            input.style.border = '1px solid #ddd';
            input.style.borderRadius = '4px';
            input.style.marginBottom = '15px';
            input.style.boxSizing = 'border-box';
            input.placeholder = '粘贴QR码扫描内容，通常格式为 [1/3][H]xxx 或 [1/3][N]xxx';
            
            // 按钮容器
            const buttons = document.createElement('div');
            buttons.style.display = 'flex';
            buttons.style.gap = '10px';
            
            // 取消按钮
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '取消';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.style.margin = '0';
            
            // 确认按钮
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '确认';
            confirmBtn.className = 'btn btn-success';
            confirmBtn.style.margin = '0';
            
            // 添加到DOM
            buttons.appendChild(cancelBtn);
            buttons.appendChild(confirmBtn);
            content.appendChild(title);
            content.appendChild(input);
            content.appendChild(buttons);
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            // 设置焦点
            setTimeout(() => input.focus(), 100);
            
            // 按钮事件
            cancelBtn.addEventListener('click', () => document.body.removeChild(dialog));
            confirmBtn.addEventListener('click', () => {
                const data = input.value.trim();
                if (data) {
                    handleQRData(data);
                }
                document.body.removeChild(dialog);
            });
        }
        
        // 处理QR码数据
        function handleQRData(data) {
            try {
                // 解析格式为 [索引/总数][编码类型]数据
                const indexMatch = data.match(/^$$(\d+)\/(\d+)$$/);
                if (!indexMatch) {
                    throw new Error('无法识别的QR码格式');
                }
                
                const index = parseInt(indexMatch[1]);
                const total = parseInt(indexMatch[2]);
                
                // 更新总块数
                if (total > totalBlocks) {
                    totalBlocks = total;
                }
                
                // 提取编码类型 (H为十六进制压缩数据，N为普通文本)
                const typeMatch = data.match(/$$([HN])$$/);
                if (!typeMatch) {
                    throw new Error('无法识别的编码类型');
                }
                
                const encodingType = typeMatch[1];
                
                // 提取数据部分
                const content = data.substring(data.indexOf(']', data.indexOf(']') + 1) + 1);
                
                // 存储块数据
                blocks[index] = {
                    content: content,
                    encoding: encodingType
                };
                
                // 播放成功提示音
                playSound(true);
                
                // 更新UI
                updateBlocksUI();
                
                // 保存到本地存储
                saveToStorage();
                
                // 显示成功消息
                showStatus(`成功扫描块 #${index}/${total}`, 'success');
                scanStatus.textContent = `已扫描 ${Object.keys(blocks).length} 个块，共 ${totalBlocks} 个`;
                
                // 如果所有块都已扫描，提示合并
                if (Object.keys(blocks).length === totalBlocks) {
                    showStatus('已扫描全部块，可以合并内容了', 'success');
                    
                    // 自动停止扫描
                    if (scanning) {
                        stopScanner();
                    }
                }
            } catch (error) {
                console.error('处理QR码数据出错:', error);
                showStatus('无法处理QR码: ' + error.message, 'error');
                
                // 播放错误提示音
                playSound(false);
            }
        }
        
        // 更新已扫描块的UI显示
        function updateBlocksUI() {
            if (Object.keys(blocks).length === 0) {
                blocksList.innerHTML = '<div style="padding:15px;text-align:center;color:#999;">尚未扫描任何内容</div>';
                missingBlocks.textContent = '';
                return;
            }
            
            // 清空列表
            blocksList.innerHTML = '';
            
            // 按索引排序
            const indices = Object.keys(blocks).map(Number).sort((a, b) => a - b);
            
            // 创建块列表
            for (const index of indices) {
                const block = blocks[index];
                
                const item = document.createElement('div');
                item.className = 'block-item';
                
                const info = document.createElement('div');
                
                const blockNum = document.createElement('span');
                blockNum.className = 'block-num';
                blockNum.textContent = `块 #${index}/${totalBlocks} `;
                
                const blockType = document.createElement('span');
                blockType.className = 'block-type';
                blockType.textContent = block.encoding === 'H' ? '(压缩数据)' : '(普通文本)';
                
                info.appendChild(blockNum);
                info.appendChild(blockType);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-block';
                deleteBtn.textContent = '删除';
                deleteBtn.addEventListener('click', () => {
                    delete blocks[index];
                    updateBlocksUI();
                    saveToStorage();
                });
                
                item.appendChild(info);
                item.appendChild(deleteBtn);
                blocksList.appendChild(item);
            }
            
            // 检查缺失的块
            if (totalBlocks > 0) {
                const missing = [];
                for (let i = 1; i <= totalBlocks; i++) {
                    if (!blocks[i]) {
                        missing.push(i);
                    }
                }
                
                if (missing.length > 0) {
                    missingBlocks.textContent = `缺失的块: ${missing.join(', ')}`;
                } else {
                    missingBlocks.textContent = '已扫描所有块!';
                }
            }
        }
        
        // 合并已扫描的块
        function mergeBlocks() {
            if (Object.keys(blocks).length === 0) {
                showStatus('没有可合并的内容', 'error');
                return;
            }
            
            try {
                // 按索引排序
                const indices = Object.keys(blocks).map(Number).sort((a, b) => a - b);
                
                // 合并内容
                let mergedContent = '';
                let isCompressed = false;
                
                for (const index of indices) {
                    const block = blocks[index];
                    mergedContent += block.content;
                    
                    // 如果有任一块是压缩的，标记整体为压缩
                    if (block.encoding === 'H') {
                        isCompressed = true;
                    }
                }
                
                // 如果是压缩内容，需要解压
                if (isCompressed) {
                    try {
                        // 将十六进制转换为字节数组
                        const bytes = new Uint8Array(mergedContent.length / 2);
                        for (let i = 0; i < mergedContent.length; i += 2) {
                            bytes[i / 2] = parseInt(mergedContent.substring(i, i + 2), 16);
                        }
                        
                        // 解压缩
                        const decompressed = pako.inflate(bytes);
                        
                        // 转换为文本
                        const decoder = new TextDecoder('utf-8');
                        mergedContent = decoder.decode(decompressed);
                    } catch (err) {
                        throw new Error('解压失败: ' + err.message);
                    }
                }
                
                // 显示结果
                resultArea.value = mergedContent;
                showStatus('内容合并成功!', 'success');
                
                // 保存合并后的结果
                localStorage.setItem('mergedResult', mergedContent);
            } catch (error) {
                console.error('合并出错:', error);
                showStatus('合并失败: ' + error.message, 'error');
            }
        }
        
        // 复制结果到剪贴板
        function copyResult() {
            const text = resultArea.value;
            
            if (!text) {
                showStatus('没有内容可复制', 'error');
                return;
            }
            
            resultArea.select();
            resultArea.setSelectionRange(0, 99999);
            
            try {
                // 尝试使用Clipboard API
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text)
                        .then(() => showStatus('已复制到剪贴板!', 'success'))
                        .catch(() => {
                            // 回退到execCommand
                            document.execCommand('copy');
                            showStatus('已复制到剪贴板!', 'success');
                        });
                } else {
                    // 回退到execCommand
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showStatus('已复制到剪贴板!', 'success');
                    } else {
                        showStatus('复制失败，请手动复制', 'warning');
                    }
                }
            } catch (err) {
                showStatus('复制失败，请手动复制', 'error');
            }
        }
        
        // 清空所有块
        function clearAllBlocks() {
            if (Object.keys(blocks).length === 0) {
                return;
            }
            
            if (confirm('确定要清空所有已扫描的内容吗?')) {
                blocks = {};
                totalBlocks = 0;
                lastResult = null;
                resultArea.value = '';
                
                updateBlocksUI();
                saveToStorage();
                
                showStatus('已清空所有内容', 'success');
                scanStatus.textContent = '准备就绪，点击按钮开始扫描';
            }
        }
        
        // 保存到本地存储
        function saveToStorage() {
            try {
                localStorage.setItem('blocks', JSON.stringify(blocks));
                localStorage.setItem('totalBlocks', totalBlocks.toString());
            } catch (e) {
                console.error('保存到本地存储失败:', e);
            }
        }
        
        // 从本地存储中恢复
        function restoreFromStorage() {
            try {
                const savedBlocks = localStorage.getItem('blocks');
                const savedTotal = localStorage.getItem('totalBlocks');
                const savedResult = localStorage.getItem('mergedResult');
                
                if (savedBlocks) {
                    blocks = JSON.parse(savedBlocks);
                }
                
                if (savedTotal) {
                    totalBlocks = parseInt(savedTotal);
                }
                
                if (savedResult) {
                    resultArea.value = savedResult;
                }
                
                updateBlocksUI();
                
                if (Object.keys(blocks).length > 0) {
                    scanStatus.textContent = `已从存储中恢复 ${Object.keys(blocks).length} 个块，共 ${totalBlocks} 个`;
                    showStatus('已从本地存储恢复数据', 'success');
                }
            } catch (e) {
                console.error('从本地存储恢复失败:', e);
            }
        }
        
        // 显示状态消息
        function showStatus(message, type, duration = 3000) {
            statusBar.textContent = message;
            statusBar.className = `status-bar status-${type}`;
            statusBar.style.display = 'block';
            
            clearTimeout(statusBar.timer);
            statusBar.timer = setTimeout(() => {
                statusBar.style.display = 'none';
            }, duration);
        }
        
        // 播放提示音
        function playSound(success) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (success) {
                    // 成功音效
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 880;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    
                    setTimeout(() => {
                        oscillator.frequency.value = 1318.51;
                    }, 80);
                    
                    setTimeout(() => {
                        oscillator.stop();
                    }, 160);
                } else {
                    // 错误音效
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 440;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    
                    setTimeout(() => {
                        oscillator.frequency.value = 392;
                    }, 100);
                    
                    setTimeout(() => {
                        oscillator.stop();
                    }, 200);
                }
            } catch (e) {
                console.log('无法播放提示音', e);
            }
        }
    </script>
</body>
</html>